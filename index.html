<!doctype html>
const SR = window.SpeechRecognition || window.webkitSpeechRecognition; let rec = null; if(SR){ rec = new SR(); rec.lang='es-CL'; rec.interimResults=false; rec.maxAlternatives=1; el('asrBadge').textContent='ðŸŽ¤ Dictado: disponible'; } else { el('asrBadge').textContent='ðŸŽ¤ Dictado: no disponible'; }


function listen(){ if(!rec){ live('El dictado no estÃ¡ disponible en este dispositivo. Puedes escribir.'); return; } rec.start(); st.listening=true; setAvatar(true); rec.onresult=(e)=>{ const txt = (e.results[0] && e.results[0][0] && e.results[0][0].transcript)||''; push('me', txt); handleQuery(txt); }; rec.onend=()=>{ st.listening=false; setAvatar(false); } }


// UI
function setAvatar(active){ avatar.classList.toggle('asleep', !active); avatar.classList.toggle('pulse', active); }
function push(who, text){ const div=document.createElement('div'); div.className = 'bubble ' + (who==='me'?'me':'maia'); div.textContent=text; el('chatlog').appendChild(div); el('chatlog').scrollTop = el('chatlog').scrollHeight; }
function live(text){ el('live').textContent = text; }


// Router simple: intenta /api/ask y cae a mock local
async function askLLM(input){
try{
const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), 3000);
const res = await fetch('/api/ask', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ input_text: input, user_locale:'es-CL', channel:'voice' }), signal:ctrl.signal});
clearTimeout(t);
if(res.ok){ return await res.json(); }
}catch(err){}
return mockAnswer(input);
}


// Mock local con KB mÃ­nima embebida (3 ejemplos)
const KB = {
cesfam_poniente: { name:'CESFAM Pudahuel Poniente', address:'Av. Federico ErrÃ¡zuriz 620, Pudahuel', phone:'+56 2 2993 6110' },
sapu_gmolina: { name:'SAPU Dr. Gustavo Molina', address:'Av. Laguna Sur 8708, Pudahuel', phone:'+56 2 2749 5991', hours:'24 horas' },
farmacia_popular: { name:'Farmacia Popular (Norte/Sur)', address:'Norte: Los Ediles 775 Â· Sur: Puerto Arturo 8261', note:'Horarios pueden variar. Verifica en Red Salud Pudahuel.' }
};


function mockAnswer(input){
const q = (input||'').toLowerCase();
if(q.includes('cesfam') || q.includes('hora')){
return { type:'steps', say:`Para pedir hora en ${KB.cesfam_poniente.name}: 1) Ten a mano tu carnet. 2) Llama en horario hÃ¡bil o acÃ©rcate al mesÃ³n. DirecciÃ³n: ${KB.cesfam_poniente.address}. TelÃ©fono: ${KB.cesfam_poniente.phone}. Â¿Te dicto el nÃºmero o te muestro un botÃ³n para llamar?`, suggestions:['Llamar ahora','CÃ³mo llegar','Otra consulta'] };
}
if(q.includes('vacun')){
return { type:'info', say:'Los puntos de vacunaciÃ³n cambian por semana. Te puedo leer los lugares activos hoy o te muestro el botÃ³n para revisar el calendario comunal.', suggestions:['Leer opciones','Abrir calendario','Otra consulta'] };
}
if(q.includes('farmacia')){
return { type:'info', say:`Farmacia Comunal: ${KB.farmacia_popular.address}. Te puedo dar las indicaciones o abrir el mapa.`, suggestions:['CÃ³mo llegar','Â¿Horarios?','Otra consulta'] };
}
if(q.includes('sapu')){
return { type:'info', say:`SAPU de urgencia cercano: ${KB.sapu_gmolina.name}, ${KB.sapu_gmolina.address}. AtenciÃ³n ${KB.sapu_gmolina.hours}. Â¿Quieres llamar?`, suggestions:['Llamar SAPU','CÃ³mo llegar','Otra consulta'] };
}
if(q.includes('examen')){
return { type:'steps', say:'Para exÃ¡menes: 1) Revisa tu orden mÃ©dica. 2) Consulta disponibilidad en tu CESFAM o laboratorio indicado. Puedo abrir bÃºsqueda o darte telÃ©fonos del CESFAM.', suggestions:['TelÃ©fono CESFAM','Buscar laboratorio','Otra consulta'] };
}
return { type:'info', say:'Puedo ayudarte con salud en Pudahuel: pedir hora, vacunas, farmacia comunal, SAPU y exÃ¡menes. Dime quÃ© necesitas y te guÃ­o paso a paso.', suggestions:['Pedir hora CESFAM','VacunaciÃ³n','Farmacia Comunal'] };
}


async function handleQuery(txt){
live('Pensandoâ€¦'); const res = await askLLM(txt); live(''); push('maia', res.say); speak(res.say); showSuggestions(res.suggestions||[]);
}


function showSuggestions(list){ const box = document.createElement('div'); box.className='row'; list.forEach((s)=>{ const b=document.createElement('button'); b.textContent=s; b.addEventListener('click',()=>{ push('me', s); handleQuery(s); }); box.appendChild(b); }); el('chatlog').appendChild(box); el('chatlog').scrollTop = el('chatlog').scrollHeight; }


// Botones
el('btnStart').onclick = ()=>{ push('maia', 'Hola, soy MAIA. Â¿QuÃ© necesitas de salud en Pudahuel? Puedo guiarte paso a paso.'); speak('Hola, soy MAIA. Â¿QuÃ© necesitas de salud en Pudahuel? Puedo guiarte paso a paso.'); };
el('btnSpeak').onclick = ()=> listen();
el('btnRepeat').onclick = ()=>{ const last = [...document.querySelectorAll('.bubble.maia')].pop(); if(last) speak(last.textContent); };
el('btnStop').onclick = ()=>{ try{ window.speechSynthesis.cancel(); }catch(e){} };
el('btnSend').onclick = ()=>{ const v=el('text').value.trim(); if(!v) return; push('me', v); el('text').value=''; handleQuery(v); };
document.getElementById('shortcuts').addEventListener('click', (e)=>{ const p=e.target.getAttribute('data-prompt'); if(!p) return; push('me', p); handleQuery(p); });


// Auto inicio por NFC/QR ?auto=1
window.addEventListener('load', ()=>{ if(st.auto){ el('btnStart').click(); } });
</script>
</body>
</html>
